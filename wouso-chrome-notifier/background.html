<html>
<head>
<script>
  var wouso_url = "https://wouso.cs.pub.ro";
  var notif_url = "https://wouso.cs.pub.ro/ajax/notifications/";
  var minutes_update = 2;
    
  chrome.browserAction.onClicked.addListener(function(tab) {
    chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && (tab.url.indexOf(wouso_url) == 0)) {
        chrome.tabs.update(tab.id, {selected: true});
        return;
      }
    }
    chrome.tabs.create({url: wouso_url});
    });
  });

  chrome.browserAction.setBadgeBackgroundColor({color:[200, 0, 0, 255]});

  function refresh() {
    var the_object = {}; 
    var http_request = new XMLHttpRequest();
    http_request.open( "GET", notif_url, true );
    http_request.onreadystatechange = function () {
    if ( http_request.readyState == 4 && http_request.status == 200 ) {
            the_object = JSON.parse( http_request.responseText );
            if ( the_object.count == -1) {
                chrome.browserAction.setIcon({path:"icon-offline.png"});
                chrome.browserAction.setBadgeText({text: null});
            }
            else {
                chrome.browserAction.setIcon({path:"icon.png"});
                if (the_object.count == 0) 
                    chrome.browserAction.setBadgeText({text: null});
                else
                    chrome.browserAction.setBadgeText({text:String(the_object.count)});
           }
        }
    };
    http_request.send(null);
  }
  window.setInterval(refresh, minutes_update * 60000);
  refresh();
</script>
</head>
</html>
